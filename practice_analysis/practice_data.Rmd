---
title: "practice_data"
author: "Yochai Shavit"
date: "October 29, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#set wd
```{r set wd}
getwd()
setwd("~/Stanford Ph.D/3rd year/Psych 251/Replication project/shavit2017/practice_analysis")
```

#load packages
```{r load packages}
library(knitr)
library(tidyverse)
library(lavaan)
library(car)
library(broom)
library(AUC)
```

#create data 
First, create dataset as it will be downloaded from Qualtrix (wide form with raw values of time and money in each of the conditions), including demographic data. This is to test if I can fit the hyperbolic discount function in R

```{r create og practice df, echo=FALSE}
#Create dataframe with values attempting to be close to the ones in the paper
df=data.frame(row.names = c(1:108))
  df$subid=c(1:108)
  df$age=ifelse(df$subid<=54, sample(x=c(60:89), size = 54, replace = T), sample(x=c(18:35), size = 54, replace = T))
  
  df$rel_1_mon=ifelse(df$subid<=54, rnorm(n=54, mean = (102.08/(1+0.32*1)), sd=20), rnorm(n=54, mean=(92.96/(1+0.19*1)), sd=20))
  df$rel_1_time=ifelse(df$subid<=54, rnorm(n=54, mean = (91.35/(1+0.33*1)), sd=20), rnorm(n=54, mean=(48.44/(1+0.43*1)), sd=20))
  
  df$rel_2_mon=ifelse(df$subid<=54, rnorm(n=54, mean = (102.08/(1+0.32*2)), sd=20), rnorm(n=54, mean=(92.96/(1+0.19*2)), sd=20))
  df$rel_2_time=ifelse(df$subid<=54, rnorm(n=54, mean = (91.35/(1+0.33*2)), sd=20), rnorm(n=54, mean=(48.44/(1+0.43*2)), sd=20))
  
  df$rel_5_mon=ifelse(df$subid<=54, rnorm(n=54, mean = (102.08/(1+0.32*5)), sd=20), rnorm(n=54, mean=(92.96/(1+0.19*5)), sd=20))
  df$rel_5_time=ifelse(df$subid<=54, rnorm(n=54, mean = (91.35/(1+0.33*5)), sd=20), rnorm(n=54, mean=(48.44/(1+0.43*5)), sd=20))
  
  df$rel_10_mon=ifelse(df$subid<=54, rnorm(n=54, mean = (102.08/(1+0.32*10)), sd=20), rnorm(n=54, mean=(92.96/(1+0.19*10)), sd=20))
  df$rel_10_time=ifelse(df$subid<=54, rnorm(n=54, mean = (91.35/(1+0.33*10)), sd=20), rnorm(n=54, mean=(48.44/(1+0.43*10)), sd=20))
  
  df$rel_20_mon=ifelse(df$subid<=54, rnorm(n=54, mean = (102.08/(1+0.32*20)), sd=20), rnorm(n=54, mean=(92.96/(1+0.19*20)), sd=20))
  df$rel_20_time=ifelse(df$subid<=54, rnorm(n=54, mean = (91.35/(1+0.33*20)), sd=20), rnorm(n=54, mean=(48.44/(1+0.43*20)), sd=20))
  
  df$rel_50_mon=ifelse(df$subid<=54, rnorm(n=54, mean = (102.08/(1+0.32*50)), sd=20), rnorm(n=54, mean=(92.96/(1+0.19*50)), sd=20))
  df$rel_50_time=ifelse(df$subid<=54, rnorm(n=54, mean = (91.35/(1+0.33*50)), sd=20), rnorm(n=54, mean=(48.44/(1+0.43*50)), sd=20))
  
  df$rel_100_mon=ifelse(df$subid<=54, rnorm(n=54, mean = (102.08/(1+0.32*100)), sd=20), rnorm(n=54, mean=(92.96/(1+0.19*100)), sd=20))
  df$rel_100_time=ifelse(df$subid<=54, rnorm(n=54, mean = (91.35/(1+0.33*100)), sd=20), rnorm(n=54, mean=(48.44/(1+0.43*100)), sd=20))
  
  df$nonrel_1_mon=ifelse(df$subid<=54, rnorm(n=54, mean = (12.48/(1+0.23*1)), sd=20), rnorm(n=54, mean=(93.35/(1+0.16*1)), sd=20))
  df$nonrel_1_time=ifelse(df$subid<=54, rnorm(n=54, mean = (14.22/(1+0.28*1)), sd=20), rnorm(n=54, mean=(47.29/(1+0.5*1)), sd=20))
  
  df$nonrel_2_mon=ifelse(df$subid<=54, rnorm(n=54, mean = (12.48/(1+0.23*2)), sd=20), rnorm(n=54, mean=(93.35/(1+0.16*2)), sd=20))
  df$nonrel_2_time=ifelse(df$subid<=54, rnorm(n=54, mean = (14.22/(1+0.28*2)), sd=20), rnorm(n=54, mean=(47.29/(1+0.5*2)), sd=20))
  
  df$nonrel_5_mon=ifelse(df$subid<=54, rnorm(n=54, mean = (12.48/(1+0.23*5)), sd=20), rnorm(n=54, mean=(93.35/(1+0.16*5)), sd=20))
  df$nonrel_5_time=ifelse(df$subid<=54, rnorm(n=54, mean = (14.22/(1+0.28*5)), sd=20), rnorm(n=54, mean=(47.29/(1+0.5*5)), sd=20))
  
  df$nonrel_10_mon=ifelse(df$subid<=54, rnorm(n=54, mean = (12.48/(1+0.23*10)), sd=20), rnorm(n=54, mean=(93.35/(1+0.16*10)), sd=20))
  df$nonrel_10_time=ifelse(df$subid<=54, rnorm(n=54, mean = (14.22/(1+0.28*10)), sd=20), rnorm(n=54, mean=(47.29/(1+0.5*10)), sd=20))
  
  df$nonrel_20_mon=ifelse(df$subid<=54, rnorm(n=54, mean = (12.48/(1+0.23*20)), sd=20), rnorm(n=54, mean=(93.35/(1+0.16*20)), sd=20))
  df$nonrel_20_time=ifelse(df$subid<=54, rnorm(n=54, mean = (14.22/(1+0.28*20)), sd=20), rnorm(n=54, mean=(47.29/(1+0.5*20)), sd=20))
  
  df$nonrel_50_mon=ifelse(df$subid<=54, rnorm(n=54, mean = (12.48/(1+0.23*50)), sd=20), rnorm(n=54, mean=(93.35/(1+0.16*50)), sd=20))
  df$nonrel_50_time=ifelse(df$subid<=54, rnorm(n=54, mean = (14.22/(1+0.28*50)), sd=20), rnorm(n=54, mean=(47.29/(1+0.5*50)), sd=20))
  
  df$nonrel_100_mon=ifelse(df$subid<=54, rnorm(n=54, mean = (12.48/(1+0.23*100)), sd=20), rnorm(n=54, mean=(93.35/(1+0.16*100)), sd=20))
  df$nonrel_100_time=ifelse(df$subid<=54, rnorm(n=54, mean = (14.22/(1+0.28*100)), sd=20), rnorm(n=54, mean=(47.29/(1+0.5*100)), sd=20))
  
  df$incm_lv=ifelse(df$subid<=54, rnorm(n=54, mean = 0.82, sd=0.59), rnorm(n=54, mean=0.94, sd=0.5))
  df$edu_lv=ifelse(df$subid<=54, sample(x=c(1:5), size=54, replace = T), sample(x=c(1:5), size = 54, replace = T))
  df$num_friends=ifelse(df$subid<=54, rnorm(n=54, mean = 10.08, sd=9.96), rnorm(n=54, mean=8.10, sd=6.97))
  df$num_relatives=ifelse(df$subid<=54, rnorm(n=54, mean = 12.36, sd=11.83), rnorm(n=54, mean=8.98, sd=6.41))

```
 
 This dataset is obviously full of impossible values (negative number of friends or value of donations). Would it make sense to set all negative values to zero? In the paper they mention fitting the curve to the group median data because it is typically not normally distributed, so using a normal distribution here probabky wouldn't be different because the mean would be the same as the median.

Let's check this:
```{r summary raw values, echo=FALSE}
summary(df$rel_1_mon);summary(df$rel_2_mon);summary(df$rel_5_mon);summary(df$rel_10_mon);summary(df$rel_20_mon);summary(df$rel_50_mon);summary(df$rel_100_mon) #-> means and medians are quite close

summary(df$rel_1_time);summary(df$rel_2_time);summary(df$rel_5_time);summary(df$rel_10_time);summary(df$rel_20_time);summary(df$rel_50_time);summary(df$rel_100_time) #-> a few have quite a difference (over 1.5 in value)

summary(df$nonrel_1_mon);summary(df$nonrel_2_mon);summary(df$nonrel_5_mon);summary(df$nonrel_10_mon);summary(df$nonrel_20_mon);summary(df$nonrel_50_mon);summary(df$nonrel_100_mon)#-> a few have quite a difference (over 1.5 in value)

summary(df$nonrel_1_time);summary(df$nonrel_2_time);summary(df$nonrel_5_time);summary(df$nonrel_10_time);summary(df$nonrel_20_time);summary(df$nonrel_50_time);summary(df$nonrel_100_time)#-> a few have quite a difference (over 1.5 in value)
```

#create second dataset, with random sampling from a certain range of values

```{r og dataset, echo=FALSE}
#Create new dataset with plausible raw values as will be downloaded from qualtrics (decrease 0.5*distance from range with each move of 1 social distance)
df_og=data.frame(row.names = c(1:108))
  df_og$subid=c(1:108)
  df_og$age=ifelse(df_og$subid<=54, sample(x=c(60:89), size = 54, replace = T), sample(x=c(18:35), size = 54, replace = T))
  
  df_og$rel_1_mon=ifelse(df_og$subid<=54, sample(size=54, x = c(75:100), replace = T), sample(size=54, x=c(70:100), replace = T))
  df_og$rel_1_time=ifelse(df_og$subid<=54, sample(size=54, x = c(75:100), replace = T), sample(size=54, x=c(40:70), replace = T))
  
  df_og$rel_2_mon=ifelse(df_og$subid<=54, sample(size=54, x = c(74:99), replace = T), sample(size=54, x=c(69:99), replace = T))
  df_og$rel_2_time=ifelse(df_og$subid<=54, sample(size=54, x = c(74:99), replace = T), sample(size=54, x=c(39:69), replace = T))
  
  df_og$rel_5_mon=ifelse(df_og$subid<=54, sample(size=54, x = c(72.5:97.5), replace = T), sample(size=54, x=c(67.5:97.5), replace = T))
  df_og$rel_5_time=ifelse(df_og$subid<=54, sample(size=54, x = c(72.5:97.5), replace = T), sample(size=54, x=c(37.5:67.5), replace = T))
  
  df_og$rel_10_mon=ifelse(df_og$subid<=54, sample(size=54, x = c(70:95), replace = T), sample(size=54, x=c(65:95), replace = T))
  df_og$rel_10_time=ifelse(df_og$subid<=54, sample(size=54, x = c(70:95), replace = T), sample(size=54, x=c(35:65), replace = T))
  
  df_og$rel_20_mon=ifelse(df_og$subid<=54, sample(size=54, x = c(65:90), replace = T), sample(size=54, x=c(60:90), replace = T))
  df_og$rel_20_time=ifelse(df_og$subid<=54, sample(size=54, x = c(65:90), replace = T), sample(size=54, x=c(30:60), replace = T))
  
  df_og$rel_50_mon=ifelse(df_og$subid<=54, sample(size=54, x = c(50:75), replace = T), sample(size=54, x=c(45:75), replace = T))
  df_og$rel_50_time=ifelse(df_og$subid<=54, sample(size=54, x = c(50:75), replace = T), sample(size=54, x=c(15:45), replace = T))
  
  df_og$rel_100_mon=ifelse(df_og$subid<=54, sample(size=54, x = c(25:50), replace = T), sample(size=54, x=c(20:50), replace = T))
  df_og$rel_100_time=ifelse(df_og$subid<=54, sample(size=54, x = c(25:50), replace = T), sample(size=54, x=c(0:20), replace = T))
  
  df_og$nonrel_1_mon=ifelse(df_og$subid<=54, sample(size=54, x = c(40:50), replace = T), sample(size=54, x=c(70:100), replace = T))
  df_og$nonrel_1_time=ifelse(df_og$subid<=54, sample(size=54, x = c(40:50), replace = T), sample(size=54, x=c(40:70), replace = T))
  
  df_og$nonrel_2_mon=ifelse(df_og$subid<=54, sample(size=54, x = c(39:49), replace = T), sample(size=54, x=c(69:99), replace = T))
  df_og$nonrel_2_time=ifelse(df_og$subid<=54, sample(size=54, x = c(39:49), replace = T), sample(size=54, x=c(39:69), replace = T))
  
  df_og$nonrel_5_mon=ifelse(df_og$subid<=54, sample(size=54, x = c(37.5:47.5), replace = T), sample(size=54, x=c(67.5:97.5), replace = T))
  df_og$nonrel_5_time=ifelse(df_og$subid<=54, sample(size=54, x = c(37.5:47.5), replace = T), sample(size=54, x=c(37.5:67.5), replace = T))
  
  df_og$nonrel_10_mon=ifelse(df_og$subid<=54, sample(size=54, x = c(35:45), replace = T), sample(size=54, x=c(65:95), replace = T))
  df_og$nonrel_10_time=ifelse(df_og$subid<=54, sample(size=54, x = c(35:45), replace = T), sample(size=54, x=c(35:65), replace = T))
  
  df_og$nonrel_20_mon=ifelse(df_og$subid<=54, sample(size=54, x = c(30:40), replace = T), sample(size=54, x=c(60:90), replace = T))
  df_og$nonrel_20_time=ifelse(df_og$subid<=54, sample(size=54, x = c(30:40), replace = T), sample(size=54, x=c(30:80), replace = T))
  
  df_og$nonrel_50_mon=ifelse(df_og$subid<=54, sample(size=54, x = c(15:25), replace = T), sample(size=54, x=c(45:75), replace = T))
  df_og$nonrel_50_time=ifelse(df_og$subid<=54, sample(size=54, x = c(15:25), replace = T), sample(size=54, x=c(15:45), replace = T))
  
  df_og$nonrel_100_mon=ifelse(df_og$subid<=54, sample(size=54, x = c(0:10), replace = T), sample(size=54, x=c(20:50), replace = T))
  df_og$nonrel_100_time=ifelse(df_og$subid<=54, sample(size=54, x = c(0:10), replace = T), sample(size=54, x=c(0:20), replace = T))
  
  df_og$incm_lv=ifelse(df_og$subid<=54, rnorm(n=54, mean = 0.82, sd=0.59), rnorm(n=54, mean=0.94, sd=0.5))
  df_og$edu_lv=ifelse(df_og$subid<=54, sample(x=c(1:4), size=54, replace = T), sample(x=c(3:5), size = 54, replace = T))
  df_og$num_friends=ifelse(df_og$subid<=54, rnorm(n=54, mean = 10.08, sd=9.96), rnorm(n=54, mean=8.10, sd=6.97))
  df_og$num_relatives=ifelse(df_og$subid<=54, rnorm(n=54, mean = 12.36, sd=11.83), rnorm(n=54, mean=8.98, sd=6.41))
  df_og$gender=sample(x=c("female", "male"), size = 108, replace=T)
  #Add age group variable
df_og$age_grp=recode(df_og$age, "lo:35='young'; 60:hi='old'", as.factor.result = T)
summary(df_og$age_grp) #-> 54 of each, like I generated the data

```

#Descriptive demographics and statistics
Measure of central tendency and age group differences as reported in the original paper
```{r descriptives}
#table of descpritive statistics
dscrpt=df_og%>%group_by(age_grp)%>%summarise(male_female_ratio=paste(sum(gender=="male"), "/", sum(gender=="female")),
Age_av=mean(age),Age_sd=sd(age), 
Education_av=mean(edu_lv),Education_sd=sd(edu_lv), Household_income_av=mean(incm_lv),Household_income_sd=sd(incm_lv), sig_relatives_av=mean(num_relatives),sig_relatives_sd=sd(num_relatives), 
sig_friends_av=mean(num_friends), sig_friends_sd=sd(num_friends))

kable(dscrpt, digits = 2, align='c', caption = "decsriptive statistics by age group")
```

```{r test for differences}
#Gender (chi-square)
with(df_og,
print(chisq.test(gender, age_grp, rescale.p = T, correct = F)))
#Age
with(df_og,
print(t.test(age~age_grp)))
#education level
with(df_og,
print(t.test(edu_lv~age_grp)))
#income level
with(df_og,
print(t.test(incm_lv~age_grp)))
#number of close relatives
with(df_og,
print(t.test(num_relatives~age_grp)))
#number of close friends
with(df_og,
print(t.test(num_friends~age_grp)))

```

**Note-** These data serve, to some extent, as a simulation of the dempgraphic effects in the original paper. The fact that the simulated values for number of close friends and relatives is sometime significant and sometimes not (for both) suggests that the finding that age groups differed in number of relatives but not in number of friends is at the very least fragile. 

#Tidy data
data needs to be long-form for the first step, whereby each row is one trail for one subject (each subject has 14 rows (donation form * social distance), for each of the 2 kinship conditions (relative/nonrelative), resulting in 28 rows in total for 108 participants, meaning 3024 observations. In addition, add age_group variable.
```{r tidy data df_og}

#long-form dataset
og_lng=df_og%>%
  gather(condition, amount,
         rel_1_mon,rel_2_mon,rel_5_mon,rel_10_mon,rel_20_mon, rel_50_mon, rel_100_mon,
         rel_1_time,rel_2_time,rel_5_time,rel_10_time,rel_20_time, rel_50_time, rel_100_time,
         nonrel_1_mon,nonrel_2_mon,nonrel_5_mon,nonrel_10_mon,nonrel_20_mon, nonrel_50_mon, nonrel_100_mon,
         nonrel_1_time,nonrel_2_time,nonrel_5_time,nonrel_10_time,nonrel_20_time, nonrel_50_time, nonrel_100_time
         )%>%
  separate(condition, c("kin", "soc_dist", "donation"), "_")%>%
  spread(kin, amount)%>%
  gather(kinship, amount,
         rel,nonrel) #-> That works!
```

#Curve fitting
Now that the dataset is tidy, proceed to attemp and fit the hyperbolic discount curve to the median value in each group (age_group-kinship-donation form)
```{r median values}
med_table=og_lng%>%group_by(age_grp,kinship,donation,soc_dist)%>%summarise(med_amnt=median(amount))
write_csv(med_table,"med_table_shavit.csv")

ggplot(data=med_table, aes(x=soc_dist, y=med_amnt, color=age_grp))+
  geom_point()+
  facet_grid(donation~kinship)

#for each age_grp*kinship*donation condition
old_rel_mon=med_table%>%filter(age_grp=="old" & kinship=="rel" & donation=="mon")
kable(old_rel_mon, digits = 2, align = 'c', caption = "Older,relative,money: median amount given")

old_rel_time=med_table%>%filter(age_grp=="old" & kinship=="rel" & donation=="time")
kable(old_rel_time, digits = 2, align = 'c', caption = "Older,relative,time: median amount given")

yng_rel_mon=med_table%>%filter(age_grp=="young" & kinship=="rel" & donation=="mon")
kable(yng_rel_mon, digits = 2, align = 'c', caption = "Younger,relative,money: median amount given")

yng_rel_time=med_table%>%filter(age_grp=="young" & kinship=="rel" & donation=="time")
kable(yng_rel_time, digits = 2, align = 'c', caption = "Younger,relative,time: median amount given")

old_nonrel_mon=med_table%>%filter(age_grp=="old" & kinship=="nonrel" & donation=="mon")
kable(old_nonrel_mon, digits = 2, align = 'c', caption = "Older,non-relative,money: median amount given")

old_nonrel_time=med_table%>%filter(age_grp=="old" & kinship=="nonrel" & donation=="time")
kable(old_nonrel_time, digits = 2, align = 'c', caption = "Older,non-relative,time: median amount given")

yng_nonrel_mon=med_table%>%filter(age_grp=="young" & kinship=="nonrel" & donation=="mon")
kable(yng_nonrel_mon, digits = 2, align = 'c', caption = "Younger,non-relative,money: median amount given")

yng_nonrel_time=med_table%>%filter(age_grp=="young" & kinship=="nonrel" & donation=="time")
kable(yng_nonrel_time, digits = 2, align = 'c', caption = "Younger,non-relative,time: median amount given")
```

#Code from Mike
```{r}
#define dataset
d=med_table
d$soc_dist=as.numeric(d$soc_dist)

# first plot
ggplot(d, 
       aes(x = soc_dist, y = med_amnt, col = age_grp)) + 
  geom_point() + 
  facet_grid(kinship ~ donation) + 
  geom_smooth(method="lm", formula = y ~ poly(x, 2), 
              se = FALSE)

# for testing
data_subset <- filter(d, age_grp == "old", 
                      kinship == "nonrel", 
                      donation == "mon")

# v=V/(1 +kN)
# where V is the undiscounted reward value, 
# v is the reward value that a person would like to forgo for the benefit for someone at a social distance N, and k is a constant indexing degree of social discounting (i.e., discount rate) across social distances.

# where R-square and root-mean-square error (RMSE) were used to assess the goodness of  t. 

# compute the hyperbolic function
discount <- function (V, k, N) {
  nu <- V / (1 + k * N)
  
  return(nu)
}

# compute RMSE for a given parameter set and data
data_vs_discount <- function(V, k, N, amount) {
  nu <- discount(V, k, N)
  
  RMSE <- sum(sqrt((amount - nu)^2))
  
  return(RMSE)
}

# wrapper to feed to optim
optim_discount_wrapper <- function(x) {
  return(data_vs_discount(V = x[1], k = x[2],  
                          N = data_subset$soc_dist, 
                          amount = data_subset$med_amnt))
}

# try fitting optimizer
opt1=optim(c(100, .2), optim_discount_wrapper)
opt1 #-> first par= V, second par=k

# get predictions on test case
data_subset$pred <- discount(V = 46, k = .02,
                             N = data_subset$soc_dist)

#Get R^2 for predictions and data
cor1=cor.test(data_subset$med_amnt, data_subset$pred)
(cor1$estimate)^2 #-> R^2 value
```

# Run for each age group, donation and kinship combination
```{r values for group medians}
#create empty vectors to store values
age_grp=vector(mode="character",length=0); donation=vector(mode="character",length=0); kinship=vector(mode="character",length=0); V_values=vector(mode="numeric",length=0); k_values=vector(mode="numeric",length=0); RMSE=vector(mode="numeric",length=0); R_sq=vector(mode="numeric",length=0)

#run for each age group, exctract values for donation * kinship conditions

for(i in unique(d$age_grp)){
  
  d_mon_rel=d%>%filter(age_grp==i, donation=="mon", kinship=="rel") #-> create temp df to get values from
  age_grp=c(age_grp,i) #-> store the appropriate age group
  donation=c(donation, "mon") #-> store the appropriate donation
  kinship=c(kinship, "rel") #-> store the appropriate kinship
  optim_discount_wrapper <- function(x) { #-> define discount wrapper to get V, k, and RMSE values for this                                                      condition
  return(data_vs_discount(V = x[1], k = x[2],  
                          N = d_mon_rel$soc_dist, 
                          amount = d_mon_rel$med_amnt))
}

  opt1=optim(c(100, .2), optim_discount_wrapper) #-> run discount_wrapper
  V_values=c(V_values,opt1$par[1]) #-> store resulting V_value
  k_values=c(k_values, opt1$par[2]) #-> store resulting k_value
  RMSE=c(RMSE, opt1$value) #-> store resulting RMSE value
  d_mon_rel$pred=discount(V = opt1$par[1], k = opt1$par[2],N = d_mon_rel$soc_dist) #-> store predictions in temp                                                                                          dataset
  cor1=cor.test(d_mon_rel$med_amnt, d_mon_rel$pred) #-> run cor.test to get correlation of predictions and data
  R_sq=c(R_sq, (cor1$estimate)^2) #-> square the estimate (pearson's R) to get R^2.
  
  
  d_mon_nonrel=d%>%filter(age_grp==i, donation=="mon", kinship=="nonrel") #-> do all of this for the next donation                                                                               * Kinship condition
  age_grp=c(age_grp,i)
  donation=c(donation, "mon")
  kinship=c(kinship, "nonrel")
  optim_discount_wrapper <- function(x) {
  return(data_vs_discount(V = x[1], k = x[2],  
                          N = d_mon_nonrel$soc_dist, 
                          amount = d_mon_nonrel$med_amnt))
}

  opt2=optim(c(100, .2), optim_discount_wrapper)
  V_values=c(V_values,opt2$par[1])
  k_values=c(k_values, opt2$par[2])
  RMSE=c(RMSE, opt2$value)
  d_mon_nonrel$pred=discount(V = opt2$par[1], k = opt2$par[2],N = d_mon_nonrel$soc_dist)
  cor2=cor.test(d_mon_nonrel$med_amnt, d_mon_nonrel$pred)
  R_sq=c(R_sq, (cor2$estimate)^2)


  d_time_rel=d%>%filter(age_grp==i, donation=="time", kinship=="rel")
  age_grp=c(age_grp,i)
  donation=c(donation, "time")
  kinship=c(kinship, "rel")
  optim_discount_wrapper <- function(x) {
  return(data_vs_discount(V = x[1], k = x[2],  
                          N = d_time_rel$soc_dist, 
                          amount = d_time_rel$med_amnt))
}

  opt3=optim(c(100, .2), optim_discount_wrapper)
  V_values=c(V_values,opt3$par[1])
  k_values=c(k_values, opt3$par[2])
  RMSE=c(RMSE, opt3$value)
  d_time_rel$pred=discount(V = opt3$par[1], k = opt3$par[2],N = d_time_rel$soc_dist)
  cor3=cor.test(d_time_rel$med_amnt, d_time_rel$pred)
  R_sq=c(R_sq, (cor3$estimate)^2)

  
  d_time_nonrel=d%>%filter(age_grp==i, donation=="time", kinship=="nonrel")
  age_grp=c(age_grp,i)
  donation=c(donation, "time")
  kinship=c(kinship, "nonrel")
  optim_discount_wrapper <- function(x) {
  return(data_vs_discount(V = x[1], k = x[2],  
                          N = d_time_nonrel$soc_dist, 
                          amount = d_time_nonrel$med_amnt))
}

  opt4=optim(c(100, .2), optim_discount_wrapper)
  V_values=c(V_values,opt4$par[1])
  k_values=c(k_values, opt4$par[2])
  RMSE=c(RMSE, opt4$value)
  d_time_nonrel$pred=discount(V = opt4$par[1], k = opt4$par[2],N = d_time_nonrel$soc_dist)
  cor4=cor.test(d_time_nonrel$med_amnt, d_time_nonrel$pred)
  R_sq=c(R_sq, (cor4$estimate)^2)

}

#Add all vectors to one dataset
med_smry=as.data.frame(cbind(age_grp, donation, kinship, V_values, k_values, R_sq, RMSE), row.names = F)%>%mutate(V_values=as.character(V_values), k_values=as.character(k_values), R_sq=as.character(R_sq), RMSE=as.character(RMSE))%>%mutate(V_values=as.numeric(V_values), k_values=as.numeric(k_values), R_sq=as.numeric(R_sq), RMSE=as.numeric(RMSE))

kable(med_smry, digits = 2, align = "c", caption = "Estimated Parameters and Goodness-of-fit Indices of the Hyperbolic Functions, group median values")
```

# finding AUC
```{r}
# first step - using Erin calculous calculator (and WolframAlpha), the integral of this discount function is:
# V/k*ln(abs(1+k*n))+c -> we don't really care about c for AUC.

# define V and k from the code above
k=opt1$par[2]
V=opt1$par[1]

#Evaluate for upper bound
up=V/k*log(abs(1+k*100))
lower=V/k*log(abs(1+k*0))

AUC=up-lower
log(AUC)
```

# for Individuals
The goal here is to create a dataset which have k and AUC values for each participant in each of the 4 donation * kinship conditions. As a second step, Age group affiliation as well as demographics data should be added to this dataset.

```{r create dataframe}
#Create the empty dataframe, in which each participant have 4 rows
df2=data.frame(cbind(
  subid=rep(unique(og_lng$subid),4),
  age_grp=c(),
  gender=c(),
  edu_lv=c(),
  incm_lv=c(),
  num_friends=c(),
  num_relatives=c(),
  kinship=c(),
  donation=c(),
  k=c(),
  AUC=c()
))

#Fill in values for demographics (age, age group, gender, education, income, num_friends, num_relatives)
for (i in unique(df2$subid)){
  df_sub=filter(df_og, subid==i)
  df2[df2$subid==i, 'age']=df_sub$age
  df2[df2$subid==i, 'age_grp']=df_sub$age_grp
  df2[df2$subid==i, 'gender']=df_sub$gender
  df2[df2$subid==i, 'edu_lv']=df_sub$edu_lv
  df2[df2$subid==i, 'incm_lv']=df_sub$incm_lv
  df2[df2$subid==i, 'num_friends']=df_sub$num_friends
  df2[df2$subid==i, 'num_relatives']=df_sub$num_relatives
}
```

```{r get k and AUC values}
#for each age individual, exctract values for donation * kinship conditions

#set varaible soc_dist in og_lng to be numeric
og_lng$soc_dist=as.character(og_lng$soc_dist)
og_lng$soc_dist=as.numeric(og_lng$soc_dist)
is.numeric(og_lng$soc_dist)

#Create 4 temporary df's to store values from each iteration
df2_mr=df2[1:108,] #-> for money_relative
df2_mnr=df2[109:216,] #->for money_nonrelative
df2_tr=df2[217:324,] #->for time_relative
df2_tnr=df2[325:432,] #->for time_nonrel

#rub discount wrapper for each subject in 2*2 conditions
for(i in unique(df2$subid)){
  #money relative
  d_mon_rel=og_lng%>%filter(subid==i, donation=="mon", kinship=="rel") #-> create temp df to get values from
  df2_mr[df2_mr$subid==i, 'donation']="mon" #-> store the appropriate donation
  df2_mr[df2_mr$subid==i, 'kinship']="rel" #-> store the appropriate kinship
  
  optim_discount_wrapper <- function(x) { #-> define discount wrapper to get V, k, and RMSE values for this                                                      condition
  return(data_vs_discount(V = x[1], k = x[2],  
                          N = d_mon_rel$soc_dist, 
                          amount = d_mon_rel$amount))
}

  opt1=optim(c(100, .2), optim_discount_wrapper) #-> run discount_wrapper
  df2_mr[df2_mr$subid==i, 'k']=opt1$par[2] #-> store resulting k_value

  # Get AUC value 
  k=opt1$par[2]
  V=opt1$par[1]

  #Evaluate for upper bound
  up=V/k*log(abs(1+k*100))
  lower=V/k*log(abs(1+k*0))

  df2_mr[df2_mr$subid==i,'AUC']=up-lower
  
#money nonrelative
  d_mon_nonrel=og_lng%>%filter(subid==i, donation=="mon", kinship=="nonrel") 
  df2_mnr[df2_mnr$subid==i, 'donation']="mon" 
  df2_mnr[df2_mnr$subid==i, 'kinship']="nonrel" 
  
  optim_discount_wrapper <- function(x) { 
  return(data_vs_discount(V = x[1], k = x[2],  
                          N = d_mon_nonrel$soc_dist, 
                          amount = d_mon_nonrel$amount))
}

  opt2=optim(c(100, .2), optim_discount_wrapper) 
  df2_mnr[df2_mnr$subid==i, 'k']=opt2$par[2] 

  # Get AUC value 
  k=opt2$par[2]
  V=opt2$par[1]

  #Evaluate for upper bound
  up=V/k*log(abs(1+k*100))
  lower=V/k*log(abs(1+k*0))

  df2_mnr[df2_mnr$subid==i,'AUC']=up-lower
  
#time relative
  d_time_rel=og_lng%>%filter(subid==i, donation=="time", kinship=="rel")
  df2_tr[df2_tr$subid==i, 'donation']="time" 
  df2_tr[df2_tr$subid==i, 'kinship']="rel" 
  
  optim_discount_wrapper <- function(x) { 
  return(data_vs_discount(V = x[1], k = x[2],  
                          N = d_time_rel$soc_dist, 
                          amount = d_time_rel$amount))
}

  opt3=optim(c(100, .2), optim_discount_wrapper) 
  df2_tr[df2_tr$subid==i, 'k']=opt3$par[2] 

  # Get AUC value 
  k=opt3$par[2]
  V=opt3$par[1]

  #Evaluate for upper bound
  up=V/k*log(abs(1+k*100))
  lower=V/k*log(abs(1+k*0))

  df2_tr[df2_tr$subid==i,'AUC']=up-lower
  
#time nonrelative
  d_time_nonrel=og_lng%>%filter(subid==i, donation=="time", kinship=="nonrel")
  df2_tnr[df2_tnr$subid==i, 'donation']="time" 
  df2_tnr[df2_tnr$subid==i, 'kinship']="nonrel" 
  
  optim_discount_wrapper <- function(x) { 
  return(data_vs_discount(V = x[1], k = x[2],  
                          N = d_time_nonrel$soc_dist, 
                          amount = d_time_nonrel$amount))
}

  opt4=optim(c(100, .2), optim_discount_wrapper) 
  df2_tnr[df2_tnr$subid==i, 'k']=opt4$par[2] 

  # Get AUC value 
  k=opt4$par[2]
  V=opt4$par[1]

  #Evaluate for upper bound
  up=V/k*log(abs(1+k*100))
  lower=V/k*log(abs(1+k*0))

  df2_tnr[df2_tnr$subid==i,'AUC']=up-lower
}

#Comnibe all into one dataframe (df2)
df2=full_join(df2_mr, df2_mnr)%>%full_join(df2_tr)%>%full_join(df2_tnr)
```

# remove outlayers
In the original paper, Gong et al state that they treated as NA each condition that could not have been fitted using the hyperbolic discount function. They indicate that this is because the amount of donation was almost theor that same across social distances. If this issue arises, I will remove those observations as well.
In addition, they excluded any k and AUC values that were more than +/- 3 *SD*s. I shall do the same
```{r remove outliers}
#mean k +3 sd
k_high=mean(df2$k)+(3*sd(df2$k))
k_low=mean(df2$k)-(3*sd(df2$k))

AUC_high=mean(df2$AUC)+(3*sd(df2$AUC))
AUC_low=mean(df2$AUC)-(3*sd(df2$AUC))


df2=df2%>%filter(k<=(mean(k)+3*sd(k)) & k>=(mean(k)-3*sd(k)) & AUC<=(mean(AUC)+3*sd(AUC))& AUC>=(mean(AUC)-3*sd(AUC))) #-> retain only observations that meet criteria

#check that the minimal values are not lower than k and AUC "_low"'s, and maximal not higher than "_high"'s
min(df2$k)<k_low; max(df2$k)>k_high; min(df2$AUC)<AUC_low; max(df2$AUC)>AUC_high
```

#Run main analysis
